<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binaural Mind & Body</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000; --card: #111; --text: #fff; --muted: #888;
            --delta: #a855f7; --theta: #22c55e; --alpha: #3b82f6; --beta: #f97316;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 500px; margin: 0 auto; overflow-x: hidden; }
        header { text-align: center; margin-bottom: 25px; }
        .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 20px; }
        .warning-box { margin-bottom: 20px; position: relative; }
        .notice { background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 10px; font-size: 0.85rem; text-align: center; line-height: 1.4; }
        .danger { color: #ff4444; font-size: 0.75rem; text-align: center; font-weight: 600; border: 1px solid #400; padding: 12px; border-radius: 12px; background: rgba(255,0,0,0.05); }
        .close-btn { position: absolute; top: 5px; right: 12px; cursor: pointer; color: var(--muted); font-size: 1.4rem; z-index: 10; }
        
        .player-container { background: linear-gradient(180deg, #151515 0%, #000 100%); border: 1px solid #222; border-radius: 25px; padding: 25px; text-align: center; margin-bottom: 25px; }
        .active-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 5px; }
        .active-desc { font-size: 0.8rem; color: var(--muted); margin-bottom: 15px; min-height: 40px; }
        .timer-ui { margin: 20px 0; }
        input[type=range] { width: 100%; accent-color: #fff; margin-top: 10px; cursor: pointer; }
        
        .play-btn { width: 70px; height: 70px; border-radius: 50%; border: none; background: #fff; color: #000; font-size: 1.5rem; cursor: pointer; margin: 0 auto; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .play-btn:active { transform: scale(0.9); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .mode-card { background: #111; padding: 15px; border-radius: 15px; border: 1px solid #222; cursor: pointer; transition: 0.3s; }
        .mode-card.selected { border-width: 2px; background: #1a1a1a; }
        
        .details { font-size: 0.8rem; background: #080808; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; text-align: left; border-left: 3px solid #fff; line-height: 1.6; }
        .detail-item { margin-bottom: 10px; }
        .detail-item b { color: #ddd; display: block; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; margin-bottom: 2px; }
        
        .quote-box { margin-top: 30px; border-top: 1px solid #222; padding-top: 20px; text-align: center; }
        .quote-text { font-style: italic; font-size: 1rem; margin-bottom: 5px; color: #eee; }
        .quote-author { color: var(--muted); font-size: 0.8rem; font-weight: 600; }
        
        .history-trigger { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; opacity: 0.7; } 

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); align-items: center; justify-content: center; }
        .modal-content { background: #111; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid #333; position: relative; }
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="history-trigger" onclick="toggleModal(true)">üïí</div>

    <div id="historyModal" class="modal" onclick="if(event.target == this) toggleModal(false)">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleModal(false)">√ó</span>
            <h3 style="margin-bottom: 20px; color: var(--alpha);">Historial de Sesiones</h3>
            <div id="history-list-content"></div>
            <button onclick="clearHistory()" style="background: none; border: none; color: #555; font-size: 0.7rem; cursor: pointer; margin-top: 15px; text-decoration: underline; width: 100%;">
                Borrar todo el historial
            </button>
        </div>
    </div>

    <header>
        <h1>Mind & Body</h1>
        <p class="subtitle">Sonidos binaurales para tu bienestar</p>
    </header>

    <div id="warning-section" class="warning-box">
        <span class="close-btn" onclick="this.parentElement.style.display='none'">√ó</span>
        <div class="notice">
            üéß <b>C√≥mo usar:</b> Es imprescindible el uso de aud√≠fonos para obtener los beneficios.
        </div>
        <div class="danger">
            ‚ö†Ô∏è NO UTILIZAR CONDUCIENDO O SI PADECE EPILEPSIA.
        </div>
    </div>

    <div class="player-container">
        <div class="active-title" id="p-name">Selecciona una frecuencia</div>
        <div class="active-desc" id="p-desc">Frecuencias: Alpha, Beta, Theta, Delta.</div>
        <div class="timer-ui">
            <label>Duraci√≥n: <span id="t-val">20</span> min</label>
            <input type="range" id="t-slider" min="5" max="90" step="5" value="20">
            <div id="elapsed-time" style="margin-top: 10px; font-weight: 600; color: var(--alpha); font-size: 1.2rem; display: none;">00:00</div>
            <button class="play-btn" id="master-btn" onclick="toggleAudio()">‚ñ∂</button>
            <div id="p-details" class="details"></div>
        </div>
    </div>

    <div class="grid">
        <div class="mode-card" id="btn-delta" onclick="setup('delta')" style="border-color: var(--delta)">
            <h4 style="color:var(--delta)">Delta</h4>
            <p style="font-size:0.7rem">Regeneraci√≥n</p>
        </div>
        <div class="mode-card" id="btn-theta" onclick="setup('theta')" style="border-color: var(--theta)">
            <h4 style="color:var(--theta)">Theta</h4>
            <p style="font-size:0.7rem">Autocuraci√≥n</p>
        </div>
        <div class="mode-card" id="btn-alpha" onclick="setup('alpha')" style="border-color: var(--alpha)">
            <h4 style="color:var(--alpha)">Alpha</h4>
            <p style="font-size:0.7rem">Aprendizaje</p>
        </div>
        <div class="mode-card" id="btn-beta" onclick="setup('beta')" style="border-color: var(--beta)">
            <h4 style="color:var(--beta)">Beta</h4>
            <p style="font-size:0.7rem">Enfoque</p>
        </div>
    </div>

    <div class="quote-box">
        <p class="quote-label" style="font-size: 0.7rem; color: var(--alpha); text-transform: uppercase; letter-spacing: 1px;">Frase del d√≠a</p>
        <p class="quote-text" id="q-txt">Cargando...</p>
        <p class="quote-author" id="q-author"></p>
    </div>

    <script>
        // --- DATA DE FRASES (Tus 100 frases respetadas) ---
        const quotes = [
            {t: "Si quieres encontrar los secretos del universo, piensa en energ√≠a, frecuencia y vibraci√≥n.", a: "Nikola Tesla"},
            {t: "La medicina del futuro ser√° la medicina de las frecuencias.", a: "Albert Einstein"},
            {t: "En todo hombre hay algo que puede ser curado por el sonido.", a: "Pit√°goras"},
            {t: "T√∫ creas tu propia realidad con tus pensamientos.", a: "Rhonda Byrne"},
            {t: "La energ√≠a fluye hacia donde va la atenci√≥n.", a: "James Redfield"},
            {t: "La mejor manera de predecir el futuro es crearlo.", a: "Benjamin Franklin"},
            {t: "Tanto si crees que puedes como si no, tienes raz√≥n.", a: "Henry Ford"},
            {t: "La imaginaci√≥n es el principio de la creaci√≥n.", a: "Neville Goddard"},
            {t: "Tu cerebro no distingue entre lo que ves y lo que recuerdas.", a: "Joe Dispenza"},
            {t: "Lo que la mente puede concebir y creer, puede lograrlo.", a: "Napoleon Hill"},
            {t: "La m√∫sica es la mediadora entre el mundo espiritual y el de los sentidos.", a: "Ludwig van Beethoven"},
            {t: "Si quieres sanar el cuerpo, primero debes sanar la mente.", a: "Plat√≥n"},
            {t: "El sonido es la fuerza creativa del universo.", a: "Hazrat Inayat Khan"},
            {t: "Tu cuerpo es un instrumento, aprende a afinarlo.", a: "An√≥nimo"},
            {t: "La vibraci√≥n de la gratitud es la m√°s poderosa que existe.", a: "Bob Proctor"},
            {t: "Todo es energ√≠a y eso es todo lo que hay.", a: "Darryl Anka"},
            {t: "La paz mental no es la ausencia de conflicto, sino la presencia de equilibrio.", a: "Deepak Chopra"},
            {t: "La conciencia es el lenguaje cu√°ntico del universo.", a: "Amit Goswami"},
            {t: "Donde termina la palabra, comienza la m√∫sica.", a: "Heinrich Heine"},
            {t: "Cambiando la frecuencia de tus pensamientos, cambias tu destino.", a: "Wayne Dyer"},
            {t: "La armon√≠a es la salud; el desequilibrio es la enfermedad.", a: "Hip√≥crates"},
            {t: "El silencio es el lienzo donde se dibujan todos los sonidos.", a: "An√≥nimo"},
            {t: "Toda enfermedad es un problema de armon√≠a musical fuera de lugar.", a: "Novalis"},
            {t: "El observador crea la realidad mediante el acto de observar.", a: "Werner Heisenberg"},
            {t: "Tu mente es un jard√≠n, tus pensamientos son las semillas.", a: "William Wordsworth"},
            {t: "No somos seres humanos teniendo una experiencia espiritual, somos seres espirituales teniendo una experiencia humana.", a:"Pierre Teilhard de Chardin"},
            {t: "La intenci√≥n es el punto de partida de cada sue√±o.", a: "Deepak Chopra"},
            {t: "Siente la frecuencia, no solo el sonido.", a: "Bruce Lee"},
            {t: "La curaci√≥n es una cuesti√≥n de tiempo, pero a veces tambi√©n es una cuesti√≥n de oportunidad.", a: "Hip√≥crates"},
            {t: "Para entender el mundo, primero debes entenderte a ti mismo como energ√≠a.", a: "Lao Ts√©"},
            {t: "La m√∫sica es la aritm√©tica de los sonidos, como la √≥ptica es la geometr√≠a de la luz.", a: "Claude Debussy"},
            {t: "Nada est√° inm√≥vil; todo se mueve; todo vibra.", a: "El Kybalion"},
            {t: "La mente lo es todo. En lo que piensas, te conviertes.", a: "Buda"},
            {t: "El universo no est√° fuera de ti. Mira dentro de ti mismo; todo lo que quieres, ya lo eres.", a: "Rumi"},
            {t: "La palabra es un sonido que tiene el poder de crear o destruir.", a: "Miguel Ruiz"},
            {t: "Nuestra intenci√≥n crea nuestra realidad.", a: "Wayne Dyer"},
            {t: "El ritmo es el latido del coraz√≥n del universo.", a: "An√≥nimo"},
            {t: "La materia es energ√≠a condensada a una vibraci√≥n lenta.", a: "Albert Einstein"},
            {t: "El pensamiento es una fuerza vibratoria tan real como la luz o la electricidad.", a: "William Walker Atkinson"},
            {t: "Cada c√©lula de tu cuerpo responde a cada pensamiento que tienes.", a: "Deepak Chopra"},
            {t: "El sonido tiene la capacidad de reorganizar la estructura molecular.", a: "Masaru Emoto"},
            {t: "Busca la frecuencia que te haga sentir vivo y sinton√≠zate con ella.", a: "An√≥nimo"},
            {t: "La claridad mental es el resultado de una frecuencia equilibrada.", a: "Joe Dispenza"},
            {t: "El universo es una sinfon√≠a de cuerdas vibrantes.", a: "Michio Kaku"},
            {t: "No te conviertes en lo que quieres, te conviertes en lo que crees.", a: "Oprah Winfrey"},
            {t: "La calma interior es el mayor de los poderes.", a: "Konosuke Matsushita"},
            {t: "Tu vibraci√≥n es tu firma en el mundo.", a: "An√≥nimo"},
            {t: "El secreto de la salud f√≠sica y mental es no llorar por el pasado, sino vivir el presente sabiamente.", a: "Buda"},
            {t: "La meditaci√≥n es el arte de escuchar el sonido del silencio.", a: "An√≥nimo"},
            {t: "Sintoniza tu mente con la abundancia y el universo responder√°.", a: "Bob Proctor"},
            {t: "La m√∫sica es el lenguaje que permite hablar con el m√°s all√°.", a: "Robert Schumann"},
            {t: "Tu visi√≥n se aclarar√° solo cuando puedas mirar en tu propio coraz√≥n.", a: "Carl Jung"},
            {t: "La salud es la mayor posesi√≥n. El contento es el mayor tesoro.", a: "Lao Ts√©"},
            {t: "En el principio era el Verbo, y el Verbo era con Dios, y el Verbo era Dios.", a: "Juan 1:1"},
            {t: "El sonido de la naturaleza es el primer lenguaje del hombre.", a: "Marius Schneider"},
            {t: "La energ√≠a de la mente es la esencia de la vida.", a: "Arist√≥teles"},
            {t: "El hombre es lo que piensa todo el d√≠a.", a: "Ralph Waldo Emerson"},
            {t: "Sobre toda cosa guardada, guarda tu coraz√≥n; porque de √©l mana la vida.", a: "Proverbios 4:23"},
            {t: "La m√∫sica puede cambiar el mundo porque puede cambiar a las personas.", a: "Bono"},
            {t: "Cualquier cosa que mantengamos en nuestra mente de forma continua es lo que experimentaremos.", a: "Tony Robbins"},
            {t: "La intuici√≥n es el susurro del alma.", a: "Jiddu Krishnamurti"},
            {t: "Como piensa el hombre en su coraz√≥n, as√≠ es √©l.", a: "Proverbios 23:7"},
            {t: "El cuerpo es el templo del esp√≠ritu; mantenlo limpio para que el alma resida en √©l.", a: "B.K.S. Iyengar"},
            {t: "La gratitud es la memoria del coraz√≥n.", a: "Lao Ts√©"},
            {t: "El pensamiento es la semilla de la acci√≥n.", a: "Emerson"},
            {t: "Panal de miel son las palabras amables: endulzan la vida y dan salud al cuerpo.", a: "Proverbios 16:24"},
            {t: "La armon√≠a invisible es mayor que la visible.", a: "Her√°clito"},
            {t: "El optimismo es la fe que conduce al logro.", a: "Helen Keller"},
            {t: "La m√∫sica limpia el alma del polvo de la vida cotidiana.", a: "Berthold Auerbach"},
            {t: "La fe viene por el o√≠r, y el o√≠r por la palabra.", a: "Romanos 10:17"},
            {t: "La vida es una progresi√≥n de estados de conciencia.", a: "Neville Goddard"},
            {t: "El universo es una construcci√≥n mental.", a: "The Kybalion"},
            {t: "Tu frecuencia vibratoria atrae tu realidad.", a: "Joe Dispenza"},
            {t: "La l√°mpara del cuerpo es el ojo; si tu ojo es bueno, todo tu cuerpo estar√° lleno de luz.", a: "Mateo 6:22"},
            {t: "El sonido es la medicina del futuro.", a: "Edgar Cayce"},
            {t: "La m√∫sica es una revelaci√≥n m√°s alta que toda la sabidur√≠a.", a: "Beethoven"},
            {t: "Donde hay amor, hay vida.", a: "Mahatma Gandhi"},
            {t: "Pedid, y se os dar√°; buscad, y hallar√©is; llamad, y se os abrir√°.", a: "Mateo 7:7"},
            {t: "La mente es como un paraca√≠das, solo funciona si se abre.", a: "Albert Einstein"},
            {t: "Lo que buscas te est√° buscando a ti.", a: "Rumi"},
            {t: "La conciencia es la clave de la curaci√≥n.", a: "Eckhart Tolle"},
            {t: "El coraz√≥n alegre constituye buen remedio; mas el esp√≠ritu triste seca los huesos.", a: "Proverbios 17:22"},
            {t: "Todo lo que somos es el resultado de lo que hemos pensado.", a: "Buda"},
            {t: "La paz comienza con una sonrisa.", a: "Madre Teresa"},
            {t: "El cuerpo nunca miente.", a: "Martha Graham"},
            {t: "Todo lo que es verdadero, honesto y justo... en esto pensad.", a: "Filipenses 4:8"},
            {t: "La m√∫sica es el arte m√°s directo, entra por el o√≠do y va al coraz√≥n.", a: "Magdalena Mart√≠nez"},
            {t: "La imaginaci√≥n lo es todo. Es el avance de las pr√≥ximas atracciones de la vida.", a: "Albert Einstein"},
            {t: "El mayor descubrimiento de mi generaci√≥n es que el hombre puede alterar su vida alterando su actitud.", a: "William James"},
            {t: "Por la fe entendemos haber sido constituido el universo por la palabra de Dios.", a: "Hebreos 11:3"},
            {t: "Sana tu mente y tu cuerpo te seguir√°.", a: "An√≥nimo"},
            {t: "El silencio es el sue√±o que nutre la sabidur√≠a.", a: "Francis Bacon"},
            {t: "La alegr√≠a es la forma m√°s alta de salud.", a: "Proverbio Chino"},
            {t: "No te conformes a este mundo, sino transf√≥rmate mediante la renovaci√≥n de tu mente.", a: "Romanos 12:2"},
            {t: "La vibraci√≥n es el lenguaje com√∫n de la naturaleza.", a: "An√≥nimo"},
            {t: "La m√∫sica es el vino que llena la copa del silencio.", a: "Robert Fripp"},
            {t: "Cree que puedes y ya habr√°s recorrido la mitad del camino.", a: "Theodore Roosevelt"},
            {t: "El Se√±or es mi pastor; nada me faltar√°.", a: "Salmos 23:1"},
            {t: "La salud es un estado de completa armon√≠a del cuerpo, mente y esp√≠ritu.", a: "B.K.S. Iyengar"},
            {t: "Tu pensamiento es el pincel con el que pintas tu vida.", a: "An√≥nimo"} 
        ];

        const data = {
            delta: { 
                n: 'Frecuencia Delta (2Hz)', d: 'Regeneraci√≥n f√≠sica y descanso profundo.', c: '#a855f7', f: 2,
                info: [
                    { q: "Cuando", v: "<b>Antes</b> de dormir." },
                    { q: "Duraci√≥n", v: "<b>Sue√±o profundo:</b> 30 min." },
                    { q: "Visualizaci√≥n", v: "Luz p√∫rpura relajante." }
                ]
            },
            theta: { 
                n: 'Frecuencia Theta (7Hz)', d: 'Autocuraci√≥n y sue√±o l√∫cido.', c: '#22c55e', f: 7,
                info: [
                    { q: "Cuando", v: "<b>Durante</b> relajaci√≥n." },
                    { q: "Duraci√≥n", v: "<b>Autocuraci√≥n</b> 20 min." },
                    { q: "Visualizaci√≥n", v: "Luz sanadora verde." }
                ]
            },
            alpha: { 
                n: 'Frecuencia Alpha (10Hz)', d: 'Relajaci√≥n consciente y aprendizaje.', c: '#3b82f6', f: 10,
                info: [
                    { q: "Cuando", v: "<b>Antes</b> de estudiar." },
                    { q: "Duraci√≥n", v: "<b>Concentraci√≥n</b> 15 min." },
                    { q: "Visualizaci√≥n", v: "Oc√©ano azul claro." }
                ]
            },
            beta: { 
                n: 'Frecuencia Beta (20Hz)', d: 'Enfoque m√°ximo y agudeza mental.', c: '#f97316', f: 20,
                info: [
                    { q: "Cuando", v: "<b>Durante</b> el trabajo anal√≠tico." },
                    { q: "Duraci√≥n", v: "15-20 min." },
                    { q: "Frecuencia", v: "M√°ximo 2 veces al d√≠a." }
                ]
            }
        };

        // --- MOTOR DE AUDIO REVISADO (Generativo + Binaural) ---
        let audioCtx, oscL, oscR, gainBinaural, ambientFilter, isRunning = false, selected = 'alpha', timerInterval, ambientLoop;
        let activeNotes = [];
        const scale = [110.00, 130.81, 146.83, 164.81, 196.00]; // Pentat√≥nica menor La2

        function setup(id, duration = null) {
            selected = id;
            if(duration) document.getElementById('t-slider').value = duration;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('btn-'+id).classList.add('selected');
            document.getElementById('p-name').innerText = data[id].n;
            document.getElementById('p-name').style.color = data[id].c;
            document.getElementById('p-desc').innerText = data[id].d;
            document.getElementById('t-val').innerText = document.getElementById('t-slider').value;
            
            let html = '';
            data[id].info.forEach(item => html += `<div class="detail-item"><b>${item.q}:</b> ${item.v}</div>`);
            const details = document.getElementById('p-details');
            details.innerHTML = html;
            details.style.display = 'block';
            details.style.borderColor = data[id].c;

            if(isRunning) stop();
            localStorage.setItem('pref_mode', selected);
            localStorage.setItem('pref_time', document.getElementById('t-slider').value);
        }

        function toggleAudio() { isRunning ? stop() : start(); }

        async function start() {
            if (isRunning) return;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            // IMPORTANTE: Definimos isRunning antes para que el loop ambiental no se cancele
            isRunning = true;

            // 1. Capa Binaural
            gainBinaural = audioCtx.createGain();
            gainBinaural.gain.setValueAtTime(0, audioCtx.currentTime);
            gainBinaural.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 2);
            
            oscL = audioCtx.createOscillator();
            const panL = audioCtx.createStereoPanner();
            oscL.frequency.value = 180; panL.pan.value = -1;
            oscL.connect(panL).connect(gainBinaural);
            
            oscR = audioCtx.createOscillator();
            const panR = audioCtx.createStereoPanner();
            oscR.frequency.value = 180 + data[selected].f; panR.pan.value = 1;
            oscR.connect(panR).connect(gainBinaural);
            
            gainBinaural.connect(audioCtx.destination);
            oscL.start(); oscR.start();

            // 2. Capa Ambiental Generativa
            ambientFilter = audioCtx.createBiquadFilter();
            ambientFilter.type = "lowpass";
            ambientFilter.frequency.value = 450; 
            ambientFilter.connect(audioCtx.destination);
            
            playAmbientNote(); // Iniciar la melod√≠a

            document.getElementById('master-btn').innerText = '‚è∏';
            document.getElementById('elapsed-time').style.display = 'block';
            
            // Reloj Contador
            let seconds = 0;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('elapsed-time').innerText = `${mins}:${secs}`;
            }, 1000);

            saveToHistory(selected, document.getElementById('t-slider').value);
            const durationMs = document.getElementById('t-slider').value * 60000;
            setTimeout(() => { if(isRunning) stop(); }, durationMs);
        }

        function playAmbientNote() {
            if (!isRunning || !audioCtx) return;

            if (activeNotes.length < 2) {
                const freq = scale[Math.floor(Math.random() * scale.length)];
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();

                osc.type = 'sawtooth';
                osc.frequency.value = freq;

                const now = audioCtx.currentTime;
                g.gain.setValueAtTime(0, now);
                g.gain.linearRampToValueAtTime(0.12, now + 4); // Volumen mel√≥dico suave
                g.gain.linearRampToValueAtTime(0, now + 9);

                osc.connect(g).connect(ambientFilter);
                osc.start(now);
                osc.stop(now + 10);

                const id = Date.now();
                activeNotes.push(id);
                osc.onended = () => {
                    g.disconnect();
                    osc.disconnect();
                    activeNotes = activeNotes.filter(n => n !== id);
                };
            }

            // Programar siguiente nota (cada 3-6 segundos)
            ambientLoop = setTimeout(playAmbientNote, 3000 + Math.random() * 3000);
        }

        function stop() {
            isRunning = false;
            clearTimeout(ambientLoop);
            clearInterval(timerInterval);

            if(audioCtx) {
                if(gainBinaural) gainBinaural.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
                setTimeout(() => { 
                    if(audioCtx) {
                        audioCtx.close(); 
                        audioCtx = null;
                    }
                }, 1600);
            }
            
            document.getElementById('elapsed-time').style.display = 'none';
            document.getElementById('master-btn').innerText = '‚ñ∂';
            activeNotes = [];
        }

        // --- HISTORIAL Y UI ---
        function toggleModal(show) {
            document.getElementById('historyModal').style.display = show ? 'flex' : 'none';
            if(show) renderHistory();
        }

        function saveToHistory(mode, time) {
            let history = JSON.parse(localStorage.getItem('binaural_log') || '[]');
            const now = new Date();
            history.unshift({
                date: now.toLocaleDateString([], {day:'2-digit', month:'2-digit'}),
                time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                mode: mode,
                duration: time
            });
            localStorage.setItem('binaural_log', JSON.stringify(history.slice(0, 10)));
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('binaural_log') || '[]');
            const list = document.getElementById('history-list-content');
            if(history.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#555;">No hay sesiones a√∫n.</p>';
                return;
            }
            list.innerHTML = history.map(item => `
                <div class="history-item">
                    <span>${item.date} <small style="color:#555">${item.time}</small></span>
                    <span style="color: var(--${item.mode})"><b>${item.mode.toUpperCase()}</b> (${item.duration} min)</span>
                </div>
            `).join('');
        }

        function clearHistory() {
            if(confirm("¬øBorrar todo el historial?")) {
                localStorage.removeItem('binaural_log');
                renderHistory();
            }
        }

        function displayDailyQuote() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const quote = quotes[dayOfYear % quotes.length];
            document.getElementById('q-txt').innerText = `"${quote.t}"`;
            document.getElementById('q-author').innerText = quote.a;
        }

        window.onload = () => {
            displayDailyQuote();
            setup(localStorage.getItem('pref_mode') || 'alpha', localStorage.getItem('pref_time') || '20');
            document.getElementById('t-slider').oninput = function() { 
                document.getElementById('t-val').innerText = this.value;
                localStorage.setItem('pref_time', this.value);
            };
        };
    </script>
</body>
</html>
